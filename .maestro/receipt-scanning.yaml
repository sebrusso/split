# E2E Test: Receipt Scanning Flow
# Tests: Take photo/select image -> OCR processing -> Item claiming
#
# Run with: maestro test .maestro/receipt-scanning.yaml
#
# Note: This test uses photo library selection for CI environments.
# For real device testing, ensure camera permissions are granted.

appId: host.exp.Exponent

---

# Step 1: Open app and navigate to home screen
- runFlow: flows/open-app.yaml

# Step 2: Navigate to an existing group (tap first group in list)
- tapOn:
    text: ".*"
    index: 1

# Wait for group detail screen
- extendedWaitUntil:
    visible: "Members"
    timeout: 10000

# Step 3: Start receipt scanning flow - tap Scan tab or button
- tapOn: "Scan"

# Step 4: Verify camera/photo screen
- extendedWaitUntil:
    visible: ".*"
    timeout: 10000

# Check for camera permission screen or camera view
- runFlow:
    when:
      visible: "Camera Access Required"
    commands:
      # If permission needed, use library instead
      - tapOn: "Choose from Library"

# If camera is available, choose library for reliability
- tapOn:
    text: "Choose from Library"
    optional: true

# Step 5: Wait for image picker
# Note: In CI, you may need to mock this or use a pre-loaded test image
- extendedWaitUntil:
    visible: ".*"
    timeout: 10000

# Select first photo if picker is shown
- tapOn:
    index: 0
    optional: true

# Step 6: Wait for OCR processing
- extendedWaitUntil:
    visible: ".*"
    timeout: 20000

# Check for processing indicators
- runFlow:
    when:
      visible: "Scanning receipt"
    commands:
      - extendedWaitUntil:
          notVisible: "Scanning receipt"
          timeout: 30000

# Step 7: Verify receipt items screen (if OCR succeeded)
- runFlow:
    when:
      visible: "items claimed"
    commands:
      - assertVisible: "items claimed"
      # Tap on an item to claim it
      - tapOn:
          index: 0
      # If claim modal appears, select a member
      - tapOn:
          text: "Alice"
          optional: true

# Step 8: Handle OCR failure case
- runFlow:
    when:
      visible: "OCR Failed"
    commands:
      - tapOn: "Add Manually"

# Step 9: Complete the flow
- tapOn:
    text: "Done|Confirm|Continue"
    optional: true

# Success - receipt flow completed (even if OCR failed, we handled it)
