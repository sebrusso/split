# Stress Test: Malformed Deep Links
# Goal: Test that invalid deep links don't crash the app
#
# Breaking scenarios:
# - Regex parsing fails on edge cases
# - URL decode throws uncaught exception
# - App crashes on malformed input
# - Empty or null values cause undefined behavior
#
# Run with: maestro test .maestro/stress/deep-link-malformed.yaml --record

appId: com.splitfree.app

---

# ========================================
# TEST 1: Empty share code
# splitfree://join/ (trailing slash, no code)
# ========================================

- openLink: "splitfree://join/"

# App should show error, not crash
- extendedWaitUntil:
    visible: ".*"
    timeout: 5000

# Check for graceful error handling
- assertVisible:
    text: "Invalid|Error|not found|invalid code"
    regex: true
  optional: true

# App should still be functional
- assertNotVisible:
    text: "crash|fatal|undefined is not"
    regex: true

# Navigate home to reset state
- tapOn:
    text: "Home|Back|Close"
    regex: true
  optional: true

# ========================================
# TEST 2: Special characters in code
# splitfree://join/!!@@##$$%%
# ========================================

- openLink: "splitfree://join/!!@@##$$%%"

- extendedWaitUntil:
    visible: ".*"
    timeout: 5000

# Should show invalid code error
- assertVisible:
    text: "Invalid|Error|not found"
    regex: true
  optional: true

# Navigate away
- tapOn:
    text: "Home|Back|Close"
    regex: true
  optional: true

# ========================================
# TEST 3: URL encoded characters
# splitfree://join/%20%00%FF
# ========================================

- openLink: "splitfree://join/%20%00%FF"

- extendedWaitUntil:
    visible: ".*"
    timeout: 5000

# Should handle gracefully
- assertNotVisible:
    text: "crash|fatal"
    regex: true

- tapOn:
    text: "Home|Back|Close"
    regex: true
  optional: true

# ========================================
# TEST 4: Very long code (buffer overflow attempt)
# ========================================

- openLink: "splitfree://join/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"

- extendedWaitUntil:
    visible: ".*"
    timeout: 5000

# Should handle gracefully
- assertNotVisible:
    text: "crash|fatal"
    regex: true

- tapOn:
    text: "Home|Back|Close"
    regex: true
  optional: true

# ========================================
# TEST 5: SQL injection attempt in code
# splitfree://join/'; DROP TABLE groups; --
# ========================================

- openLink: "splitfree://join/'; DROP TABLE groups; --"

- extendedWaitUntil:
    visible: ".*"
    timeout: 5000

# App should sanitize input
- assertNotVisible:
    text: "crash|fatal|SQL"
    regex: true

- tapOn:
    text: "Home|Back|Close"
    regex: true
  optional: true

# ========================================
# TEST 6: Script injection attempt
# splitfree://join/<script>alert(1)</script>
# ========================================

- openLink: "splitfree://join/<script>alert(1)</script>"

- extendedWaitUntil:
    visible: ".*"
    timeout: 5000

- assertNotVisible:
    text: "crash|fatal"
    regex: true

- tapOn:
    text: "Home|Back|Close"
    regex: true
  optional: true

# ========================================
# TEST 7: Valid-looking but non-existent code
# ========================================

- openLink: "splitfree://join/ABCDEF"

- extendedWaitUntil:
    visible: ".*"
    timeout: 10000

# Should show "group not found" or similar
- assertVisible:
    text: "not found|Invalid|doesn't exist|expired"
    regex: true
  optional: true

- tapOn:
    text: "Home|Back|Close"
    regex: true
  optional: true

# ========================================
# TEST 8: Unknown deep link path
# splitfree://unknown/path
# ========================================

- openLink: "splitfree://unknown/path"

- extendedWaitUntil:
    visible: ".*"
    timeout: 5000

# Should handle unknown routes gracefully
- assertNotVisible:
    text: "crash|fatal"
    regex: true

# ========================================
# TEST 9: Settlement deep link with expired/invalid ID
# ========================================

- openLink: "splitfree://settle/EXPIRED123"

- extendedWaitUntil:
    visible: ".*"
    timeout: 5000

- assertVisible:
    text: "expired|not found|Invalid"
    regex: true
  optional: true

# ========================================
# TEST 10: Unicode characters in code
# ========================================

- openLink: "splitfree://join/ÊµãËØï‰ª£Á†Åüéâ"

- extendedWaitUntil:
    visible: ".*"
    timeout: 5000

- assertNotVisible:
    text: "crash|fatal"
    regex: true

# ========================================
# FINAL VERIFICATION
# App should still be fully functional
# ========================================

# Navigate to home
- tapOn:
    text: "Home|Back|Groups"
    regex: true
  optional: true

# Verify app is responsive
- assertVisible: "SplitFree"

# Try a normal action to confirm app works
- tapOn:
    text: "Create Group"
    optional: true

- assertVisible:
    text: "New Group|Create"
    regex: true
  optional: true

- tapOn:
    text: "Cancel|Back"
    regex: true
  optional: true
