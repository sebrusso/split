# Stress Test: Malformed Deep Links
# Goal: Test that invalid deep links don't crash the app
#
# Breaking scenarios:
# - Regex parsing fails on edge cases
# - URL decode throws uncaught exception
# - App crashes on malformed input
#
# Run with: maestro test .maestro/stress/deep-link-malformed.yaml

appId: com.splitfree.app

---

# ========================================
# TEST 1: Empty share code
# ========================================

- openLink: "splitfree://join/"

# App should not crash
- extendedWaitUntil:
    visible: ".*"
    timeout: 5000

- assertNotVisible: "crash"
- assertNotVisible: "fatal"

# Try to go home
- tapOn:
    text: "Home"
    optional: true
- tapOn:
    text: "Back"
    optional: true
- tapOn:
    text: "Close"
    optional: true

# ========================================
# TEST 2: Special characters in code
# ========================================

- openLink: "splitfree://join/TEST123"

- extendedWaitUntil:
    visible: ".*"
    timeout: 5000

- assertNotVisible: "crash"

- tapOn:
    text: "Home"
    optional: true
- tapOn:
    text: "Back"
    optional: true

# ========================================
# TEST 3: Very long code
# ========================================

- openLink: "splitfree://join/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"

- extendedWaitUntil:
    visible: ".*"
    timeout: 5000

- assertNotVisible: "crash"

- tapOn:
    text: "Home"
    optional: true
- tapOn:
    text: "Back"
    optional: true

# ========================================
# TEST 4: Unknown deep link path
# ========================================

- openLink: "splitfree://unknown/path"

- extendedWaitUntil:
    visible: ".*"
    timeout: 5000

- assertNotVisible: "crash"

# ========================================
# TEST 5: Settlement deep link with invalid ID
# ========================================

- openLink: "splitfree://settle/INVALID123"

- extendedWaitUntil:
    visible: ".*"
    timeout: 5000

- assertNotVisible: "crash"

# ========================================
# FINAL VERIFICATION
# App should still be fully functional
# ========================================

# Navigate to home
- tapOn:
    text: "Home"
    optional: true
- tapOn:
    text: "Back"
    optional: true

# Launch fresh to verify app works
- launchApp

# Verify app is responsive
- assertVisible: "SplitFree"

# Try a normal action to confirm app works
- tapOn:
    text: "Create Group"
    optional: true

- tapOn:
    text: "Cancel"
    optional: true
- tapOn:
    text: "Back"
    optional: true
