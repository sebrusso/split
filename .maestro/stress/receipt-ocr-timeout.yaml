# Stress Test: Receipt OCR Timeout
# Goal: Test behavior when OCR processing takes too long or fails
#
# Breaking scenarios:
# - Infinite loading state
# - Orphaned receipt record in database
# - No recovery option for user
#
# Run with: maestro test .maestro/stress/receipt-ocr-timeout.yaml

appId: host.exp.Exponent

---

# Step 1: Launch app
- launchApp

- assertVisible: "split it."

# Step 2: Navigate to a group
- tapOn:
    index: 0

- extendedWaitUntil:
    visible: "Expenses"
    timeout: 10000

# Step 3: Start receipt scanning flow
- tapOn:
    text: "Scan Receipt"
    optional: true

# Step 4: Check for camera/photo options
- extendedWaitUntil:
    visible: "Take Photo"
    timeout: 5000

# Step 5: Choose from library
- tapOn:
    text: "Choose"
    optional: true
- tapOn:
    text: "Library"
    optional: true

# Step 6: Select an image (if picker is visible)
- tapOn:
    index: 0
    optional: true

# Step 7: Wait for OCR processing
- extendedWaitUntil:
    visible: "Processing"
    timeout: 10000

# Step 8: Wait for processing to complete or timeout
- extendedWaitUntil:
    visible: "Receipt Items"
    timeout: 45000

# Step 9: Check what state we're in

# If we see items, OCR worked
- tapOn:
    text: "Done"
    optional: true

# If we see error, check for recovery option
- tapOn:
    text: "Add Manually"
    optional: true

# Step 10: Navigate back
- tapOn:
    text: "Back"
    optional: true
- tapOn:
    text: "Cancel"
    optional: true

# Step 11: Verify no orphaned receipt
- extendedWaitUntil:
    visible: "Expenses"
    timeout: 10000

# Step 12: Check for phantom "processing" receipts
- assertNotVisible: "Processing"

# Step 13: Memory check - try another action
- tapOn: "Add Expense"

# App should be responsive
- assertVisible: "Amount"

- tapOn:
    text: "Cancel"
    optional: true
- swipe:
    direction: DOWN
    duration: 200

# ========================================
# FINAL VERIFICATION
# ========================================

# App should be fully functional
- assertVisible: "Expenses"
- assertNotVisible: "Error"
- assertNotVisible: "crash"
