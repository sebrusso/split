# Stress Test: Offline/Online Network Chaos
# Goal: Test behavior when network is unstable
#
# Breaking scenarios:
# - Sync queue processes duplicates
# - Partial sync leaves orphaned records
# - Real-time subscription reconnection fails
#
# Run with: maestro test .maestro/stress/offline-online-chaos.yaml
#
# NOTE: This test simulates offline behavior through rapid actions

appId: host.exp.Exponent

---

# Step 1: Launch app (online)
- launchApp

- assertVisible: "SplitFree"

# Step 2: Navigate to a group
- tapOn:
    index: 0

- extendedWaitUntil:
    visible: "Expenses"
    timeout: 10000

# Step 3: Start adding an expense
- tapOn: "Add Expense"

- tapOn:
    id: "expense-description-input"
- inputText: "Offline Test Expense 1"
- pressKey: Enter

- tapOn:
    id: "expense-amount-input"
- inputText: "25.00"
- pressKey: Enter

# Step 4: Save the expense
- tapOn: "Save"

# Step 5: Immediately add another expense before first saves
- tapOn: "Add Expense"

- tapOn:
    id: "expense-description-input"
- inputText: "Offline Test Expense 2"
- pressKey: Enter

- tapOn:
    id: "expense-amount-input"
- inputText: "50.00"
- pressKey: Enter

- tapOn: "Save"

# Step 6: And another
- tapOn: "Add Expense"

- tapOn:
    id: "expense-description-input"
- inputText: "Offline Test Expense 3"
- pressKey: Enter

- tapOn:
    id: "expense-amount-input"
- inputText: "75.00"
- pressKey: Enter

- tapOn: "Save"

# Step 7: Wait for all to sync
- extendedWaitUntil:
    visible: "Offline Test Expense"
    timeout: 15000

# Step 8: Pull to refresh
- swipe:
    direction: DOWN
    duration: 500

# Wait for refresh
- extendedWaitUntil:
    visible: "Offline Test"
    timeout: 10000

# Step 9: CRITICAL ASSERTIONS
# All expenses should appear
- assertVisible: "Offline Test Expense 1"
- assertVisible: "Offline Test Expense 2"
- assertVisible: "Offline Test Expense 3"

# No duplicates or errors
- assertNotVisible: "Error"
- assertNotVisible: "sync failed"

# Step 10: Navigate to balances
- tapOn: "Balances"

- extendedWaitUntil:
    visible: "Who Owes Who"
    timeout: 15000

# Balances should be correct (total = $150)
- assertVisible: "$"
- assertNotVisible: "NaN"
- assertNotVisible: "undefined"
