# Stress Test: Multi-Currency Precision Chaos
# Goal: Expose currency conversion and rounding errors
#
# Breaking scenarios:
# - Exchange rate fetch fails silently (1:1 fallback)
# - Rounding errors compound across multiple currencies
# - Balance mismatch due to rate timing differences
# - JPY/KRW (no decimal) currencies handled incorrectly
#
# Run with: maestro test .maestro/stress/currency-chaos.yaml --record

appId: com.splitfree.app

---

# Step 1: Launch app
- launchApp

- assertVisible: "SplitFree"

# Step 2: Create a group (assumes USD base currency)
- tapOn: "Create Group"

- tapOn:
    id: "group-name-input"
- inputText: "Currency Chaos Test"

- tapOn: "Create"

- extendedWaitUntil:
    visible: "Currency Chaos Test"
    timeout: 10000

# Step 3: Add members
- tapOn: "Add Member"
- tapOn:
    id: "member-name-input"
- inputText: "Alice"
- tapOn: "Add"

- tapOn: "Add Member"
- tapOn:
    id: "member-name-input"
- inputText: "Bob"
- tapOn: "Add"

# ========================================
# TEST 1: Add expense in EUR
# ========================================

- tapOn: "Add Expense"

- tapOn:
    id: "expense-description-input"
- inputText: "Euro Expense"

- tapOn:
    id: "expense-amount-input"
- inputText: "100.00"

# Change currency if option exists
- tapOn:
    text: "USD|Currency|\\$"
    regex: true
  optional: true

- tapOn:
    text: "EUR"
    optional: true

- tapOn:
    text: "Who paid?"
    optional: true
- tapOn:
    text: "Alice"
    optional: true

- tapOn: "Save"

- extendedWaitUntil:
    visible: "Euro Expense"
    timeout: 10000

# ========================================
# TEST 2: Add expense in JPY (no decimals)
# This is tricky - JPY doesn't use cents
# ========================================

- tapOn: "Add Expense"

- tapOn:
    id: "expense-description-input"
- inputText: "Yen Expense"

- tapOn:
    id: "expense-amount-input"
# JPY typically uses whole numbers (5000 yen, not 50.00)
- inputText: "5000"

- tapOn:
    text: "USD|Currency|\\$"
    regex: true
  optional: true

- tapOn:
    text: "JPY"
    optional: true

- tapOn:
    text: "Who paid?"
    optional: true
- tapOn:
    text: "Bob"
    optional: true

- tapOn: "Save"

- extendedWaitUntil:
    visible: "Yen Expense"
    timeout: 10000

# ========================================
# TEST 3: Add expense in GBP
# ========================================

- tapOn: "Add Expense"

- tapOn:
    id: "expense-description-input"
- inputText: "Pound Expense"

- tapOn:
    id: "expense-amount-input"
- inputText: "75.50"

- tapOn:
    text: "USD|Currency|\\$"
    regex: true
  optional: true

- tapOn:
    text: "GBP"
    optional: true

- tapOn:
    text: "Who paid?"
    optional: true
- tapOn:
    text: "Alice"
    optional: true

- tapOn: "Save"

- extendedWaitUntil:
    visible: "Pound Expense"
    timeout: 10000

# ========================================
# TEST 4: Rapid currency switching during entry
# ========================================

- tapOn: "Add Expense"

- tapOn:
    id: "expense-description-input"
- inputText: "Currency Switch Test"

- tapOn:
    id: "expense-amount-input"
- inputText: "123.45"

# Rapidly switch currencies
- tapOn:
    text: "USD|Currency"
    regex: true
  optional: true

- tapOn:
    text: "EUR"
    optional: true

- tapOn:
    text: "EUR|Currency"
    regex: true
  optional: true

- tapOn:
    text: "GBP"
    optional: true

- tapOn:
    text: "GBP|Currency"
    regex: true
  optional: true

- tapOn:
    text: "USD"
    optional: true

- tapOn:
    text: "Who paid?"
    optional: true
- tapOn:
    text: "Alice"
    optional: true

- tapOn: "Save"

- extendedWaitUntil:
    visible: "Currency Switch"
    timeout: 10000

# ========================================
# VERIFY BALANCES
# ========================================

- tapOn: "Balances"

- extendedWaitUntil:
    visible: "Who Owes Who"
    timeout: 15000

# CRITICAL ASSERTIONS

# Balances should show valid amounts
- assertVisible:
    text: "\\$[0-9]"
    regex: true

# No NaN or Infinity from conversion errors
- assertNotVisible:
    text: "NaN|Infinity|undefined"
    regex: true

# No obviously wrong amounts (like JPY 5000 showing as $5000 USD)
# This would indicate 1:1 fallback bug
# 5000 JPY should be roughly $35-40 USD (depending on rates)

# Check for error messages about exchange rates
- assertNotVisible:
    text: "exchange.*failed|rate.*error"
    regex: true
  optional: true

# ========================================
# FINAL VERIFICATION
# ========================================

# Navigate back to expenses
- tapOn:
    text: "Back|Expenses"
    regex: true
  optional: true

# All expenses should be visible
- assertVisible: "Euro Expense"
- assertVisible: "Yen Expense"
- assertVisible: "Pound Expense"
- assertVisible: "Currency Switch"

# Currency symbols should display correctly (if shown)
- assertVisible:
    text: "EUR|JPY|GBP|USD|€|¥|£|\\$"
    regex: true
  optional: true
