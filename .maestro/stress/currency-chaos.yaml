# Stress Test: Multi-Currency Precision Chaos
# Goal: Expose currency conversion and rounding errors
#
# Breaking scenarios:
# - Exchange rate fetch fails silently
# - Rounding errors compound across currencies
# - JPY (no decimal) handled incorrectly
#
# Run with: maestro test .maestro/stress/currency-chaos.yaml

appId: host.exp.Exponent

---

# Step 1: Open app and navigate to home screen
- runFlow: ../flows/open-app.yaml

# Step 2: Create a group
# Try "Create Your First Group" (empty state) or "+" FAB (has groups)
- tapOn:
    text: "Create.*Group"
    optional: true

- tapOn:
    text: "\\+"
    optional: true

- assertVisible: "Group Name"

- tapOn:
    text: "e.g., Vacation 2025, Roommates"
- eraseText: 50
- inputText: "Currency Chaos Test"
- pressKey: Enter

- pressKey: Enter
- tapOn: "ðŸ’°"

- tapOn: "Create Group"

- extendedWaitUntil:
    visible: "Currency Chaos Test"
    timeout: 10000

# Dismiss any errors
- tapOn:
    text: "Dismiss"
    optional: true

# Step 3: Add members
- tapOn: "Add"
- tapOn:
    text: "Enter member's name"
- inputText: "Alice"
- pressKey: Enter
- tapOn: "Add Member"

- extendedWaitUntil:
    visible: "Currency Chaos Test"
    timeout: 5000

- tapOn: "Add"
- tapOn:
    text: "Enter member's name"
- inputText: "Bob"
- pressKey: Enter
- tapOn: "Add Member"

- extendedWaitUntil:
    visible: "Currency Chaos Test"
    timeout: 5000

# ========================================
# TEST 1: Add expense in USD
# ========================================

- tapOn:
    text: "Add Expense"

- tapOn:
    text: "e.g., Dinner, Uber, Groceries"
- inputText: "USD Test"
- pressKey: Enter

- pressKey: Enter
- tapOn:
    text: "0.00"
- inputText: "100.00"
- pressKey: Enter

- pressKey: Enter
- tapOn: "Paid by"
- tapOn: "Alice"

- tapOn: "Add Expense"

- extendedWaitUntil:
    visible: "USD Test"
    timeout: 10000

# ========================================
# TEST 2: Add expense with decimal precision
# ========================================

- tapOn:
    text: "Add Expense"

- tapOn:
    text: "e.g., Dinner, Uber, Groceries"
- inputText: "Precision Test"
- pressKey: Enter

- pressKey: Enter
- tapOn:
    text: "0.00"
- inputText: "33.33"
- pressKey: Enter

- pressKey: Enter
- tapOn: "Paid by"
- tapOn: "Bob"

- tapOn: "Add Expense"

- extendedWaitUntil:
    visible: "Precision Test"
    timeout: 10000

# ========================================
# FINAL VERIFICATION
# ========================================

- tapOn: "View Balances"

- extendedWaitUntil:
    visible: "Individual Balances"
    timeout: 10000

# No NaN or calculation errors
- assertNotVisible: "NaN"
- assertNotVisible: "undefined"
