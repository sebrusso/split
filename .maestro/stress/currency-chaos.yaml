# Stress Test: Multi-Currency Precision Chaos
# Goal: Expose currency conversion and rounding errors
#
# Breaking scenarios:
# - Exchange rate fetch fails silently
# - Rounding errors compound across currencies
# - JPY (no decimal) handled incorrectly
#
# Run with: maestro test .maestro/stress/currency-chaos.yaml

appId: com.splitfree.app

---

# Step 1: Launch app
- launchApp

- assertVisible: "SplitFree"

# Step 2: Create a group
- tapOn: "Create Group"

- tapOn:
    id: "group-name-input"
- inputText: "Currency Chaos Test"

- tapOn: "Create"

- extendedWaitUntil:
    visible: "Currency Chaos Test"
    timeout: 10000

# Step 3: Add members
- tapOn: "Add Member"
- tapOn:
    id: "member-name-input"
- inputText: "Alice"
- tapOn: "Add"

- tapOn: "Add Member"
- tapOn:
    id: "member-name-input"
- inputText: "Bob"
- tapOn: "Add"

# ========================================
# TEST 1: Add expense in USD
# ========================================

- tapOn: "Add Expense"

- tapOn:
    id: "expense-description-input"
- inputText: "USD Expense"

- tapOn:
    id: "expense-amount-input"
- inputText: "100.00"

- tapOn: "Who paid?"
- tapOn: "Alice"

- tapOn: "Save"

- extendedWaitUntil:
    visible: "USD Expense"
    timeout: 10000

# ========================================
# TEST 2: Add expense with different amount
# ========================================

- tapOn: "Add Expense"

- tapOn:
    id: "expense-description-input"
- inputText: "Second Expense"

- tapOn:
    id: "expense-amount-input"
- inputText: "123.45"

- tapOn: "Who paid?"
- tapOn: "Bob"

- tapOn: "Save"

- extendedWaitUntil:
    visible: "Second Expense"
    timeout: 10000

# ========================================
# TEST 3: Add expense with fractional cents
# ========================================

- tapOn: "Add Expense"

- tapOn:
    id: "expense-description-input"
- inputText: "Fractional Test"

- tapOn:
    id: "expense-amount-input"
- inputText: "33.33"

- tapOn: "Who paid?"
- tapOn: "Alice"

- tapOn: "Save"

- extendedWaitUntil:
    visible: "Fractional Test"
    timeout: 10000

# ========================================
# VERIFY BALANCES
# ========================================

- tapOn: "Balances"

- extendedWaitUntil:
    visible: "Who Owes Who"
    timeout: 15000

# CRITICAL ASSERTIONS
- assertVisible: "$"
- assertNotVisible: "NaN"
- assertNotVisible: "Infinity"
- assertNotVisible: "undefined"

# ========================================
# FINAL VERIFICATION
# ========================================

# Navigate back to expenses
- tapOn:
    text: "Back"
    optional: true

# All expenses should be visible
- assertVisible: "USD Expense"
- assertVisible: "Second Expense"
- assertVisible: "Fractional Test"
