# Stress Test: Member Claim Collision
# Goal: Race condition when claiming the same member
#
# Breaking scenarios:
# - No atomicity on member claiming UPDATE
# - Last-write-wins without conflict detection
# - UI shows "claimed" but server rejected
#
# Run with: maestro test .maestro/stress/member-claim-collision.yaml

appId: com.splitfree.app

---

# Step 1: Launch app
- launchApp

- assertVisible: "SplitFree"

# Step 2: Create a fresh group with an unclaimed member
- tapOn: "Create Group"

- tapOn:
    id: "group-name-input"
- inputText: "Member Claim Race Test"

- tapOn: "Create"

- extendedWaitUntil:
    visible: "Member Claim Race Test"
    timeout: 10000

# Step 3: Add a member that will be claimed
- tapOn: "Add Member"

- tapOn:
    id: "member-name-input"
- inputText: "John Unclaimed"

- tapOn: "Add"

# Verify member appears
- assertVisible: "John Unclaimed"

# Step 4: RAPID CLAIM ATTEMPT
- tapOn:
    text: "Claim"
    optional: true

# Step 5: IMMEDIATELY navigate back before claim resolves
- swipe:
    direction: RIGHT
    duration: 100

# Step 6: Navigate back into the group
- tapOn:
    text: "Member Claim Race Test"
    optional: true

# Wait for group to load
- extendedWaitUntil:
    visible: "John"
    timeout: 5000

# Step 7: Try to claim AGAIN (this is the collision)
- tapOn:
    text: "Claim"
    optional: true

# Step 8: Rapid claim/unclaim toggle
- repeat:
    times: 3
    commands:
      - tapOn:
          text: "Claim"
          optional: true
      - tapOn:
          text: "Unclaim"
          optional: true

# Step 9: Wait for state to settle
- extendedWaitUntil:
    visible: "John"
    timeout: 5000

# Step 10: CRITICAL ASSERTIONS
- assertVisible: "John"
- assertNotVisible: "Error"
- assertNotVisible: "failed"
- assertNotVisible: "conflict"

# Step 11: Navigate away and back to verify persistence
- swipe:
    direction: RIGHT
    duration: 200

# Go back to group
- tapOn:
    text: "Member Claim Race Test"
    optional: true

# Step 12: Verify member state persisted correctly
- extendedWaitUntil:
    visible: "John"
    timeout: 5000
