# Stress Test: Double Settlement Attempt
# Goal: Attempt to settle the same debt twice to expose idempotency issues
#
# Breaking scenarios:
# - No idempotency on settlement creation
# - Duplicate settlement records in database
# - Balance goes negative after double settlement
#
# Run with: maestro test .maestro/stress/double-settlement.yaml

appId: host.exp.Exponent

---

# Step 1: Open app and navigate to home screen
- runFlow: ../flows/open-app.yaml

# Step 2: Create a new group for clean state
- tapOn:
    text: "Create.*Group"
    optional: true

- tapOn:
    text: "\\+"
    optional: true

- assertVisible: "Group Name"

- tapOn:
    text: "e.g., Vacation 2025, Roommates"
- eraseText: 50
- inputText: "Double Settlement Test"
- pressKey: Enter

- pressKey: Enter
- tapOn: "ðŸ’°"
- tapOn: "Create Group"

- extendedWaitUntil:
    visible: "Double Settlement Test"
    timeout: 10000

- tapOn:
    text: "Dismiss"
    optional: true

# Step 3: Add first member (Alice - payer)
- tapOn: "Add"
- tapOn:
    text: "Enter member's name"
- inputText: "Alice"
- pressKey: Enter
- tapOn: "Add Member"

- extendedWaitUntil:
    visible: "Double Settlement Test"
    timeout: 5000

# Step 4: Add second member (Bob - owes money)
- tapOn: "Add"
- tapOn:
    text: "Enter member's name"
- inputText: "Bob"
- pressKey: Enter
- tapOn: "Add Member"

- extendedWaitUntil:
    visible: "Double Settlement Test"
    timeout: 5000

# Verify members added
- assertVisible: "Alice"
- assertVisible: "Bob"

# Step 5: Add an expense - Alice pays $100
- tapOn:
    text: "Add Expense"

- tapOn:
    text: "e.g., Dinner, Uber, Groceries"
- inputText: "Test Expense for Double Settlement"
- pressKey: Enter

- pressKey: Enter
- tapOn:
    text: "0.00"
- inputText: "100.00"
- pressKey: Enter

- pressKey: Enter
- tapOn: "Paid by"
- tapOn: "Alice"

- tapOn: "Add Expense"

- extendedWaitUntil:
    visible: "Test Expense"
    timeout: 10000

# Step 6: Navigate to balances
- tapOn: "View Balances"

- extendedWaitUntil:
    visible: "Individual Balances"
    timeout: 10000

# Step 7: Verify initial balance - Bob should owe Alice
- assertVisible: "Bob"
- assertVisible: "owes"

# Step 8: FIRST SETTLEMENT ATTEMPT
- tapOn:
    text: "Settle"
    optional: true

# Step 9: Immediately go back WITHOUT completing
- tapOn:
    text: "Cancel"
    optional: true

# Step 10: RAPID SECOND SETTLEMENT ATTEMPT
- tapOn:
    text: "Settle"
    optional: true

# Step 11: Complete the settlement
- tapOn:
    text: "Confirm"
    optional: true

# Step 12: Quickly try THIRD settlement
- tapOn:
    text: "Settle"
    optional: true

- tapOn:
    text: "Confirm"
    optional: true

# Step 13: CRITICAL ASSERTION - Balance should not be negative
- assertNotVisible: "-$50"
- assertNotVisible: "-$100"

# Success - no double settlement occurred
