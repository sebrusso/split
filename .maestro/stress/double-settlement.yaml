# Stress Test: Double Settlement Attempt
# Goal: Attempt to settle the same debt twice to expose idempotency issues
#
# Breaking scenarios:
# - No idempotency on settlement creation
# - Duplicate settlement records in database
# - Balance goes negative after double settlement
#
# Run with: maestro test .maestro/stress/double-settlement.yaml

appId: com.splitfree.app

---

# Step 1: Launch app
- launchApp

- assertVisible: "SplitFree"

# Step 2: Create a new group for clean state
- tapOn: "Create Group"

- assertVisible: "New Group"

# Enter group name
- tapOn:
    id: "group-name-input"
- inputText: "Double Settlement Test"

# Create group
- tapOn: "Create"

# Wait for group to be created
- extendedWaitUntil:
    visible: "Double Settlement Test"
    timeout: 10000

# Step 3: Add first member (Alice - payer)
- tapOn: "Add Member"
- tapOn:
    id: "member-name-input"
- inputText: "Alice"
- tapOn: "Add"

# Step 4: Add second member (Bob - owes money)
- tapOn: "Add Member"
- tapOn:
    id: "member-name-input"
- inputText: "Bob"
- tapOn: "Add"

# Verify members added
- assertVisible: "Alice"
- assertVisible: "Bob"

# Step 5: Add an expense - Alice pays $100
- tapOn: "Add Expense"

- tapOn:
    id: "expense-description-input"
- inputText: "Test Expense for Double Settlement"

- tapOn:
    id: "expense-amount-input"
- inputText: "100.00"

# Select Alice as payer
- tapOn: "Who paid?"
- tapOn: "Alice"

# Save expense
- tapOn: "Save"

# Wait for expense to be created
- extendedWaitUntil:
    visible: "Test Expense"
    timeout: 10000

# Step 6: Navigate to balances
- tapOn: "Balances"

# Wait for balance calculation
- extendedWaitUntil:
    visible: "Who Owes Who"
    timeout: 10000

# Step 7: Verify initial balance - Bob should owe Alice
- assertVisible: "Bob"
- assertVisible: "owes"

# Step 8: FIRST SETTLEMENT ATTEMPT
- tapOn: "Settle Up"

# Verify settlement screen
- assertVisible: "Settlement"

# Step 9: Immediately go back WITHOUT completing
- tapOn:
    text: "Back"
    optional: true
- tapOn:
    text: "Cancel"
    optional: true

# Step 10: RAPID SECOND SETTLEMENT ATTEMPT
- tapOn: "Settle Up"

# Step 11: Complete the settlement
- tapOn:
    text: "Confirm"
    optional: true
- tapOn:
    text: "Mark as Paid"
    optional: true
- tapOn:
    text: "Done"
    optional: true

# Step 12: Quickly go back and try THIRD settlement
- tapOn:
    text: "Back"
    optional: true

- tapOn:
    text: "Settle Up"
    optional: true

# Try to confirm again
- tapOn:
    text: "Confirm"
    optional: true
- tapOn:
    text: "Mark as Paid"
    optional: true

# Step 13: Navigate to balances to check final state
- tapOn: "Balances"

# Step 14: CRITICAL ASSERTION - Balance should not be negative
# Look for negative dollar amounts which would indicate double settlement
- assertNotVisible: "-$50"
- assertNotVisible: "-$100"

# Step 15: Check that balances show settled or zero
- extendedWaitUntil:
    visible: "Balances"
    timeout: 5000
