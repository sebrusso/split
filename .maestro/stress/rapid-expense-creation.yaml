# Stress Test: Rapid Expense Creation
# Goal: Create many expenses rapidly to stress balance calculation
#
# Breaking scenarios:
# - Race between expense insert and balance refetch
# - Floating point accumulation errors
# - Real-time subscription storm causing UI freeze
#
# Run with: maestro test .maestro/stress/rapid-expense-creation.yaml

appId: host.exp.Exponent

---

# Step 1: Launch app
- launchApp

- assertVisible: "SplitFree"

# Step 2: Navigate to existing group or create one
- tapOn:
    index: 0

- extendedWaitUntil:
    visible: "Expenses"
    timeout: 10000

# ========================================
# RAPID EXPENSE CREATION - 10 expenses, no waiting
# ========================================

# Expense 1
- tapOn: "Add Expense"
- tapOn:
    id: "expense-description-input"
- inputText: "Stress 1"
- pressKey: Enter
- tapOn:
    id: "expense-amount-input"
- inputText: "12.34"
- pressKey: Enter
- tapOn: "Save"

# Expense 2 - DON'T wait for save to complete
- tapOn: "Add Expense"
- tapOn:
    id: "expense-description-input"
- inputText: "Stress 2"
- pressKey: Enter
- tapOn:
    id: "expense-amount-input"
- inputText: "56.78"
- pressKey: Enter
- tapOn: "Save"

# Expense 3
- tapOn: "Add Expense"
- tapOn:
    id: "expense-description-input"
- inputText: "Stress 3"
- pressKey: Enter
- tapOn:
    id: "expense-amount-input"
- inputText: "90.12"
- pressKey: Enter
- tapOn: "Save"

# Expense 4
- tapOn: "Add Expense"
- tapOn:
    id: "expense-description-input"
- inputText: "Stress 4"
- pressKey: Enter
- tapOn:
    id: "expense-amount-input"
- inputText: "34.56"
- pressKey: Enter
- tapOn: "Save"

# Expense 5
- tapOn: "Add Expense"
- tapOn:
    id: "expense-description-input"
- inputText: "Stress 5"
- pressKey: Enter
- tapOn:
    id: "expense-amount-input"
- inputText: "78.90"
- pressKey: Enter
- tapOn: "Save"

# Expense 6
- tapOn: "Add Expense"
- tapOn:
    id: "expense-description-input"
- inputText: "Stress 6"
- pressKey: Enter
- tapOn:
    id: "expense-amount-input"
- inputText: "23.45"
- pressKey: Enter
- tapOn: "Save"

# Expense 7
- tapOn: "Add Expense"
- tapOn:
    id: "expense-description-input"
- inputText: "Stress 7"
- pressKey: Enter
- tapOn:
    id: "expense-amount-input"
- inputText: "67.89"
- pressKey: Enter
- tapOn: "Save"

# Expense 8
- tapOn: "Add Expense"
- tapOn:
    id: "expense-description-input"
- inputText: "Stress 8"
- pressKey: Enter
- tapOn:
    id: "expense-amount-input"
- inputText: "0.01"
- pressKey: Enter
- tapOn: "Save"

# Expense 9
- tapOn: "Add Expense"
- tapOn:
    id: "expense-description-input"
- inputText: "Stress 9"
- pressKey: Enter
- tapOn:
    id: "expense-amount-input"
- inputText: "999.99"
- pressKey: Enter
- tapOn: "Save"

# Expense 10
- tapOn: "Add Expense"
- tapOn:
    id: "expense-description-input"
- inputText: "Stress 10"
- pressKey: Enter
- tapOn:
    id: "expense-amount-input"
- inputText: "0.10"
- pressKey: Enter
- tapOn: "Save"

# ========================================
# IMMEDIATE NAVIGATION TO BALANCES
# ========================================

- tapOn: "Balances"

# Wait for balances to load (this is where races manifest)
- extendedWaitUntil:
    visible: "Who Owes Who"
    timeout: 30000

# CRITICAL ASSERTIONS
- assertNotVisible: "NaN"
- assertNotVisible: "undefined"
- assertNotVisible: "Error"

# Balances should be visible (not blank)
- assertVisible: "$"

# Navigate back to expenses list
- tapOn:
    text: "Back"
    optional: true

# Verify expenses appear
- assertVisible: "Stress 1"
- assertVisible: "Stress 10"
